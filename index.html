<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HabitMaster ‚Äî Dayo (Firebase)</title>
  <meta name="theme-color" content="#071428" />

  <style>
    :root{
      --bg:#071022; --muted:#9bb0cf; --glass:rgba(255,255,255,0.03);
      --accent1:#7c3aed; --accent2:#06b6d4; --radius:14px;
      --shadow:0 14px 36px rgba(2,6,23,0.6);
      --fast:180ms; --mid:320ms; --slow:520ms;
      --nav-bg:#0a152b;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071022 0%, #041428 100%);color:#eaf3ff;-webkit-font-smoothing:antialiased}

    /* HEADER */
    .header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(255,255,255,0.02);position:sticky;top:0;z-index:40}
    .today-date{font-weight:700}
    .user-bubble{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:13px}
    .sign-btn{background:none;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;color:var(--muted);cursor:pointer}

    /* WEEK BAR */
    .weekbar{display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(255,255,255,0.02);backdrop-filter:blur(6px);box-shadow:var(--shadow);position:sticky;top:56px;z-index:30}
    .week-arrow{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:rgba(255,255,255,0.03);cursor:pointer}
    .week-strip{display:flex;flex:1;gap:8px}
    .week-col{flex:1;text-align:center;font-size:12px;color:var(--muted);cursor:pointer;padding:8px;border-radius:10px;transition:all var(--mid)}
    .week-col .num{display:block;font-size:18px;font-weight:700;color:#fff}
    .week-col.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;transform:translateY(-4px);box-shadow:0 8px 22px rgba(12,30,100,0.45)}

    /* APP */
    .app{padding:16px;padding-bottom:180px}
    .habit-card{display:flex;align-items:center;gap:12px;padding:14px;border-radius:12px;background:rgba(255,255,255,0.02);box-shadow:0 6px 20px rgba(0,0,0,0.5);margin-bottom:12px;transition:transform var(--mid),opacity var(--mid),filter var(--mid);touch-action:pan-y;overflow:hidden}
    .habit-card.done{opacity:.5;filter:grayscale(.2);text-decoration:line-through}
    .habit-row{display:flex;align-items:center;gap:12px;width:100%}
    .check{width:36px;height:36px;border-radius:50%;border:2px solid currentColor;display:grid;place-items:center;cursor:pointer;flex-shrink:0;transition:all var(--mid)}
    .check.filled{background:currentColor;box-shadow:0 10px 24px rgba(0,0,0,0.45);transform:scale(1.18)}
    .icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;background:rgba(255,255,255,0.02)}
    .meta{flex:1;min-width:0;display:flex;flex-direction:column}
    .title{font-weight:700;font-size:15px}
    .time{font-size:13px;color:var(--muted)}
    .btn-del{border:1px solid rgba(255,255,255,0.06);background:none;color:var(--muted);padding:6px 10px;border-radius:10px;font-size:13px;cursor:pointer}
    .habit-extra{font-size:13px;color:#b7cde6;padding:8px 6px 0 6px;display:none}
    .habit-card.expanded .habit-extra{display:block}

    /* FAB */
    .fab{position:fixed;right:18px;bottom:120px;width:64px;height:64px;border-radius:50%;display:grid;place-items:center;font-size:30px;background:linear-gradient(135deg,var(--accent1),var(--accent2));border:none;color:white;box-shadow:var(--shadow);cursor:pointer;z-index:50}

    /* MOTIVATION POPUP */
    .motiv-popup{
      position:fixed;left:50%;bottom:160px;transform:translateX(-50%) translateY(20px);
      background:linear-gradient(135deg,var(--accent1),var(--accent2));
      padding:14px 22px;border-radius:12px;font-size:18px;font-weight:700;
      opacity:0;transition:all .4s ease;pointer-events:none;z-index:80;
      box-shadow:0 10px 30px rgba(0,0,0,0.45);
    }
    .motiv-popup.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* MODALS */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
    .modal{width:100%;max-width:540px;background:#071428;border-radius:14px;padding:16px;box-shadow:var(--shadow);max-height:84vh;overflow:auto}
    .icon-grid,.color-grid{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
    .icon-choice{width:48px;height:48px;border-radius:12px;background:#071a2b;display:grid;place-items:center;font-size:22px;cursor:pointer;transition:transform .16s}
    .icon-choice.active{outline:3px solid rgba(255,255,255,0.06);transform:scale(1.12)}
    .color-choice{width:36px;height:36px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:transform .2s}
    .color-choice.active{box-shadow:0 6px 18px rgba(0,0,0,0.5);transform:translateY(-4px)}

    /* CONFIRM BOX */
    .confirm-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:70}
    .confirm-box{background:#071428;border-radius:14px;padding:18px;box-shadow:var(--shadow);width:92%;max-width:420px;color:white;text-align:center}
    .confirm-btns{display:flex;gap:12px;margin-top:16px}
    .cbtn{flex:1;padding:12px;border-radius:12px;font-weight:700;border:none;cursor:pointer}

    /* AUTH */
    .small-ico{font-size:14px;margin-right:6px}

    /* BOTTOM NAV */
    .bottom-nav{
      position:fixed;
      bottom:20px;
      left:50%;transform:translateX(-50%);
      width:86%;
      background:var(--nav-bg);
      padding:12px 18px;
      border-radius:22px;
      display:flex;
      justify-content:space-around;
      align-items:center;
      box-shadow:0 10px 30px rgba(0,0,0,0.4);
      z-index:90;
    }
    .nav-item{
      font-size:22px;
      opacity:.55;
      transition:all .25s;
      cursor:pointer;
    }
    .nav-item.active{
      opacity:1;
      transform:translateY(-4px) scale(1.15);
      color:var(--accent2);
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <div class="left"><div class="today-date" id="todayDate">...</div></div>
    <div class="status-row" id="authRow">
      <button id="btnSignIn" class="sign-btn">Zaloguj</button>
    </div>
  </div>

  <!-- WEEK BAR -->
  <div class="weekbar">
    <div class="week-arrow" id="prevWeek">‚óÄ</div>
    <div class="week-strip" id="weekBar"></div>
    <div class="week-arrow" id="nextWeek">‚ñ∂</div>
  </div>

  <!-- MOTIVATION POPUP -->
  <div class="motiv-popup" id="motivPopup">Super!</div>

  <!-- APP -->
  <div class="app" id="dayView">
    <div id="habitsList"></div>
    <div id="emptyState" style="opacity:.6;text-align:center;margin-top:20px">Brak nawyk√≥w</div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <div class="nav-item active" id="navHome">üè†</div>
    <div class="nav-item" id="navEvents">üìÖ</div>
    <div class="nav-item" id="navSettings">‚öôÔ∏è</div>
  </div>

  <!-- FAB -->
  <button class="fab" id="openAdd" title="Dodaj nawyk">Ôºã</button>

  <!-- ADD MODAL -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" id="addModal">
      <h3>Dodaj nawyk</h3>

      <label>Nazwa</label>
      <input id="habitName" placeholder="Np. ƒÜwiczenia" style="width:100%;padding:10px;border-radius:10px;background:#041826;color:white;border:none;margin:8px 0" />

      <label>Opis (opcjonalnie)</label>
      <textarea id="habitDesc" placeholder="Kr√≥tki opis..." style="width:100%;padding:10px;border-radius:10px;background:#041826;color:white;border:none;margin:8px 0;height:70px"></textarea>

      <label>Ikona</label>
      <div class="icon-grid" id="iconGrid"></div>

      <label>Kolor</label>
      <div class="color-grid" id="colorGrid"></div>

      <label>Powtarzanie</label>
      <select id="recurrence" style="width:100%;padding:10px;border-radius:10px;background:#041826;color:white;border:none;margin:8px 0">
        <option value="once">Tylko dzi≈õ</option>
        <option value="daily">Codziennie</option>
        <option value="repeat">PowtarzajƒÖce siƒô</option>
      </select>

      <div id="weekSelect" style="display:none" class="icon-grid"></div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1">
          <label>Start</label>
          <input type="time" id="startTime" style="width:100%;padding:10px;border-radius:10px;background:#041826;color:white;border:none;margin-top:6px" />
        </div>
        <div style="flex:1">
          <label>Koniec</label>
          <input type="time" id="endTime" style="width:100%;padding:10px;border-radius:10px;background:#041826;color:white;border:none;margin-top:6px" />
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="saveAdd" style="flex:1;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;font-size:16px;cursor:pointer">Dodaj nawyk</button>
        <button id="cancelAdd" style="flex:0 0 60px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:none;color:var(--muted);">Anuluj</button>
      </div>
    </div>
  </div>

  <!-- CONFIRM DELETE -->
  <div class="confirm-backdrop" id="confirmBackdrop">
    <div class="confirm-box" id="confirmBox">
      <div class="confirm-title" id="confirmTitle">Usu≈Ñ nawyk?</div>
      <div class="confirm-text" id="confirmText">Co zrobiƒá z tym nawykiem?</div>
      <div class="confirm-btns" id="confirmBtns"></div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal-backdrop" id="authBackdrop">
    <div class="modal">
      <h3>Zaloguj siƒô</h3>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <button id="googleSign" class="small" style="flex:1;padding:10px;border-radius:10px;border:none;background:#4285f4;color:white">Zaloguj przez Google</button>
        <button id="showEmail" class="small" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:none;color:var(--muted)">Email</button>
      </div>

      <div id="emailForm" style="display:none;flex-direction:column;gap:8px">
        <input id="emailInput" class="email-input" placeholder="Email" />
        <input id="passInput" class="email-input" placeholder="Has≈Ço" type="password" />

        <div style="display:flex;gap:8px">
          <button id="emailSignUp" class="small" style="flex:1;padding:10px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white">Zarejestruj</button>
          <button id="emailSignIn" class="small" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:none;color:var(--muted)">Zaloguj</button>
        </div>
      </div>

      <button id="authClose" class="link-like" style="margin-top:10px">Zamknij</button>
    </div>
  </div>

  
    <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signOut,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    setPersistence,
    browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  import {
    getFirestore,
    collection,
    query,
    onSnapshot,
    addDoc,
    doc,
    updateDoc,
    deleteDoc,
    setDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  /* ========== CONFIG ========== */
  const firebaseConfig = {
    apiKey: "AIzaSyDkTe80eNt90_mM-f5zNWiGzACrWymzM-w",
    authDomain: "dayo-e3b32.firebaseapp.com",
    projectId: "dayo-e3b32",
    storageBucket: "dayo-e3b32.firebasestorage.app",
    messagingSenderId: "971722853532",
    appId: "1:971722853532:web:d13bc8493764d5da347159",
    measurementId: "G-0LXNQBVZWR"
  };

  /* ========== INIT ========== */
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // Ensure auth persistence in browser (so user stays logged in after closing)
  setPersistence(auth, browserLocalPersistence).catch(err => {
    console.warn('setPersistence failed:', err);
  });

  /* ========== STATE & HELPERS ========== */
  const DAY_NAMES = ['pon','wt','≈õr','czw','pt','sob','nd'];
  let today = new Date(); today.setHours(0,0,0,0);
  let currentDate = new Date(); currentDate.setHours(0,0,0,0);
  let weekOffset = 0;

  const todayEl = document.getElementById('todayDate');
  const weekBar = document.getElementById('weekBar');
  const habitsList = document.getElementById('habitsList');
  const emptyState = document.getElementById('emptyState');
  const openAddBtn = document.getElementById('openAdd');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const iconGrid = document.getElementById('iconGrid');
  const colorGrid = document.getElementById('colorGrid');
  const weekSelect = document.getElementById('weekSelect');
  const recurrence = document.getElementById('recurrence');

  const authBackdrop = document.getElementById('authBackdrop');
  const googleSign = document.getElementById('googleSign');
  const showEmail = document.getElementById('showEmail');
  const emailForm = document.getElementById('emailForm');
  const emailInput = document.getElementById('emailInput');
  const passInput = document.getElementById('passInput');
  const emailSignUp = document.getElementById('emailSignUp');
  const emailSignIn = document.getElementById('emailSignIn');
  const authClose = document.getElementById('authClose');
  const btnSignIn = document.getElementById('btnSignIn');
  const authRow = document.getElementById('authRow');

  const saveAdd = document.getElementById('saveAdd');
  const cancelAdd = document.getElementById('cancelAdd');
  const habitNameInput = document.getElementById('habitName');
  const habitDescInput = document.getElementById('habitDesc');
  const startTimeInput = document.getElementById('startTime');
  const endTimeInput = document.getElementById('endTime');

  const confirmBackdrop = document.getElementById('confirmBackdrop');
  const confirmTitle = document.getElementById('confirmTitle');
  const confirmText = document.getElementById('confirmText');
  const confirmBtns = document.getElementById('confirmBtns');

  const motivPopup = document.getElementById('motivPopup');
  const navHome = document.getElementById('navHome');
  const navEvents = document.getElementById('navEvents');
  const navSettings = document.getElementById('navSettings');

  // caches populated from Firestore snapshots
  let habitsCache = [];
  let completionsCache = {}; // merged view (server merged with optimistic)
  let serverCompletions = {}; // last received from server

  // optimistic local toggles: { 'YYYY-MM-DD': { habitId: true/false } }
  let optimisticCompletions = {};

  // pickers - expanded icon set
  const ICONS = [
    'üèÉ','üöø','üö¥','üèä','üèãÔ∏è‚Äç‚ôÇÔ∏è','üßò','üõå','‚òï','üçé','üçΩÔ∏è','üßπ','üß∫','üßª','üßº',
    'ü™•','üíä','üìö','‚úçÔ∏è','üñ•Ô∏è','üìÖ','üéµ','üéß','üéØ','üé®','üß©','üíº','üõí','üöó','üå±','üßë‚Äçüç≥','ü™¥','üîß','ü™ë','üßØ','üõ†Ô∏è','üßë‚Äçüî¨','üßë‚Äçüè´'
  ];
  const COLORS = ['#3b82f6','#ef4444','#22c55e','#f59e0b','#a855f7','#06b6d4','#fb7185','#10b981','#f97316','#8b5cf6','#0ea5a4','#f43f5e'];
  let selectedIcon = ICONS[0];
  let selectedColor = COLORS[0];
  let selectedDays = [];

  function iso(d){ return d.toISOString().slice(0,10); }
  function dayIdxFromDate(d){ return (d.getDay()+6)%7; } // Mon=0..Sun=6

  /* ========== UTILS: merge server + optimistic ======== */
  function mergeServerAndOptimistic(server, optimistic){
    // server and optimistic are objects keyed by date -> map
    const merged = {...server};
    for(const date in optimistic){
      merged[date] = {...(merged[date]||{}), ...(optimistic[date]||{})};
    }
    return merged;
  }

  /* ========== UI: Week bar & Today ======== */
  function renderTodayDate(){
    const opts={day:'numeric',month:'long',year:'numeric'};
    todayEl.textContent = today.toLocaleDateString('pl-PL',opts);
  }
  function weekStartFromOffset(){
    const base = new Date(currentDate);
    const day = base.getDay();
    const monday = new Date(base);
    monday.setDate(base.getDate() - ((day+6)%7) + weekOffset*7);
    monday.setHours(0,0,0,0);
    return monday;
  }
  function renderWeekBar(){
    weekBar.innerHTML='';
    const start = weekStartFromOffset();
    for(let i=0;i<7;i++){
      const d=new Date(start); d.setDate(start.getDate()+i);
      const col = document.createElement('div'); col.className='week-col';
      col.innerHTML = `<small>${DAY_NAMES[i]}</small><span class='num'>${d.getDate()}</span>`;
      if(iso(d) === iso(currentDate)) col.classList.add('active');
      col.onclick = ()=>{ currentDate = new Date(d); renderAll(); };
      weekBar.appendChild(col);
    }
  }
  document.getElementById('prevWeek').onclick = ()=>{ weekOffset--; renderAll(); };
  document.getElementById('nextWeek').onclick = ()=>{ weekOffset++; renderAll(); };

  /* ========== PICKERS INIT ========== */
  function initPickers(){
    iconGrid.innerHTML=''; colorGrid.innerHTML='';
    ICONS.forEach((ic,idx)=>{
      const el = document.createElement('div'); el.className='icon-choice'; el.textContent=ic;
      el.onclick = ()=>{ selectedIcon=ic; [...iconGrid.children].forEach(x=>x.classList.remove('active')); el.classList.add('active'); };
      iconGrid.appendChild(el); if(idx===0) el.classList.add('active');
    });
    COLORS.forEach((c,idx)=>{
      const el = document.createElement('div'); el.className='color-choice'; el.style.background=c;
      el.onclick = ()=>{ selectedColor=c; [...colorGrid.children].forEach(x=>x.classList.remove('active')); el.classList.add('active'); };
      colorGrid.appendChild(el); if(idx===0) el.classList.add('active');
    });
    weekSelect.innerHTML=''; DAY_NAMES.forEach((d,i)=>{
      const b=document.createElement('div'); b.className='icon-choice'; b.style.width='44px'; b.style.height='44px'; b.textContent=d;
      b.onclick = ()=>{ if(selectedDays.includes(i)) selectedDays = selectedDays.filter(x=>x!==i); else selectedDays.push(i); b.classList.toggle('active'); };
      weekSelect.appendChild(b);
    });
  }
  initPickers();
  recurrence.onchange = (e)=> {
    weekSelect.style.display = e.target.value === 'repeat' ? 'flex' : 'none';
    if(e.target.value === 'daily'){ selectedDays = [0,1,2,3,4,5,6]; [...weekSelect.children].forEach(n=>n.classList.add('active')); }
    if(e.target.value !== 'repeat'){ selectedDays = []; [...weekSelect.children].forEach(n=>n.classList.remove('active')); }
  };

  /* ========== AUTH UI & flows ========== */
  function renderAuthUI(){
    authRow.innerHTML = '';
    const current = auth.currentUser;
    if(current){
      const span = document.createElement('div'); span.className='user-bubble'; span.textContent = current.email || current.displayName || 'User';
      const btn = document.createElement('button'); btn.className='sign-btn'; btn.textContent='Wyloguj';
      btn.onclick = async ()=> {
        try{
          await signOut(auth);
        }catch(e){
          console.error('signOut err', e);
        }
      };
      authRow.append(span, btn);
    } else {
      const btn = document.createElement('button'); btn.id='btnSignInLocal'; btn.className='sign-btn'; btn.textContent='Zaloguj';
      btn.onclick = ()=> authBackdrop.style.display='flex';
      authRow.append(btn);
    }
  }
  btnSignIn.onclick = ()=> authBackdrop.style.display='flex';
  authClose.onclick = ()=> authBackdrop.style.display='none';
  showEmail.onclick = ()=> { emailForm.style.display = 'flex'; };

  googleSign.onclick = async ()=>{
    try{
      await signInWithPopup(auth, provider);
      authBackdrop.style.display='none';
    } catch(e){
      console.error('B≈ÇƒÖd logowania Google:', e);
      alert('B≈ÇƒÖd logowania Google: '+(e.message||e));
    }
  };
  emailSignUp.onclick = async ()=>{ 
    const email = emailInput.value.trim(); const pass = passInput.value;
    if(!email||!pass) return alert('Wpisz email i has≈Ço');
    try{
      await createUserWithEmailAndPassword(auth,email,pass);
      authBackdrop.style.display='none';
    } catch(e){ console.error('register err', e); alert('B≈ÇƒÖd rejestracji: '+(e.message||e)); }
  };
  emailSignIn.onclick = async ()=>{ 
    const email = emailInput.value.trim(); const pass = passInput.value;
    if(!email||!pass) return alert('Wpisz email i has≈Ço');
    try{
      await signInWithEmailAndPassword(auth,email,pass);
      authBackdrop.style.display='none';
    } catch(e){ console.error('signin err', e); alert('B≈ÇƒÖd logowania: '+(e.message||e)); }
  };

  /* ========== FIRESTORE REALTIME SYNC ========== */
  let unsubHab = null, unsubComp = null;

  function startRealtimeSync(uid){
    console.log('Starting realtime sync for uid=', uid);
    if(unsubHab) try{ unsubHab(); }catch(e){}
    if(unsubComp) try{ unsubComp(); }catch(e){}

    // habits
    const colRef = collection(db, `users/${uid}/habits`);
    const q = query(colRef);
    unsubHab = onSnapshot(q, snapshot=>{
      const newCache = [];
      snapshot.forEach(ds=>{
        const data = ds.data();
        data._docId = ds.id;
        newCache.push(data);
      });
      habitsCache = newCache;
      console.log('habits snapshot', habitsCache);
      renderDay();
    }, err=>{ console.error('habits onSnapshot err', err); });

    // completions (documents keyed by date)
    const compRef = collection(db, `users/${uid}/completions`);
    const q2 = query(compRef);
    unsubComp = onSnapshot(q2, snapshot=>{
      const comps = {};
      snapshot.forEach(ds=>{
        const d = ds.data();
        if(d && d.date && d.map) comps[d.date] = d.map;
      });
      // keep server copy and merge with optimistic local toggles
      serverCompletions = comps;
      completionsCache = mergeServerAndOptimistic(serverCompletions, optimisticCompletions);
      console.log('completions snapshot (merged)', completionsCache);
      renderDay();
    }, err=>{ console.error('comps onSnapshot err', err); });
  }

  /* ========== HELPERS: CRUD & completions (ONLINE ONLY) ========== */
  function requireUserOrThrow(){
    const u = auth.currentUser;
    if(!u) throw new Error('Musisz byƒá zalogowany, aby wykonaƒá tƒô operacjƒô.');
    return u;
  }

  async function addHabitToServer(h){
    const u = requireUserOrThrow();
    const payload = {...h};
    delete payload._tempId;
    try{
      const ref = await addDoc(collection(db, `users/${u.uid}/habits`), {...payload, createdAt: serverTimestamp()});
      console.log('habit added, id=', ref.id);
    }catch(e){
      console.error('addHabitToServer err', e);
      throw e;
    }
    // onSnapshot will update local habitsCache
  }

  async function deleteHabitOnServer(docId){
    const u = requireUserOrThrow();
    try{
      await deleteDoc(doc(db, `users/${u.uid}/habits`, docId));
      console.log('deleted habit', docId);
    }catch(e){
      console.error('deleteHabitOnServer err', e);
      throw e;
    }
  }

  async function addExclusionOnServer(docId, dateIso){
    const u = requireUserOrThrow();
    try{
      const docRef = doc(db, `users/${u.uid}/habits`, docId);
      const hLocal = habitsCache.find(x=>x._docId===docId);
      const exclusions = (hLocal?.exclusions || []);
      if(!exclusions.includes(dateIso)) exclusions.push(dateIso);
      await updateDoc(docRef, { exclusions });
      console.log('added exclusion', dateIso, 'to', docId);
    }catch(e){
      console.error('addExclusionOnServer err', e);
      throw e;
    }
  }

  async function toggleCompletionServer(habitDocId, dateIso){
    const u = requireUserOrThrow();
    try{
      const docRef = doc(db, `users/${u.uid}/completions`, dateIso);
      // merge optimistic with server by reading current server copy in memory (serverCompletions)
      const existing = serverCompletions[dateIso] ? {...serverCompletions[dateIso]} : {};
      // Apply optimistic pending flips where present
      existing[habitDocId] = !existing[habitDocId];
      await setDoc(docRef, { userId: u.uid, date: dateIso, map: existing }, { merge: true });
      console.log('toggled completion (server)', habitDocId, dateIso, existing[habitDocId]);
    }catch(e){
      console.error('toggleCompletionServer err', e);
      throw e;
    } finally {
      // no-op: optimisticCompletions will be reconciled when snapshot arrives
    }
  }

  /* ========== RENDER DAY ======== */
  function matches(h,d){
    if(!h) return false;
    if(h.recurrence === 'once') return h.date === iso(d);
    if(h.recurrence === 'daily') return !(Array.isArray(h.exclusions) && h.exclusions.includes(iso(d)));
    if(h.recurrence === 'repeat'){
      const idx = dayIdxFromDate(d);
      const inDays = Array.isArray(h.days) && h.days.includes(idx);
      const excluded = Array.isArray(h.exclusions) && h.exclusions.includes(iso(d));
      return inDays && !excluded;
    }
    return false;
  }

  function renderDay(){
    const list = habitsList; list.innerHTML='';
    // ensure completionsCache visible is merged latest
    completionsCache = mergeServerAndOptimistic(serverCompletions, optimisticCompletions);
    const items = (habitsCache||[]).filter(h=>matches(h,currentDate)).sort((a,b)=> (a.start||'').localeCompare(b.start||'') || (a.name||'').localeCompare(b.name||''));
    emptyState.style.display = items.length ? 'none' : 'block';
    let idx = 0;
    items.forEach(h=>{
      const card = document.createElement('div'); card.className='habit-card';
      // pop-in animation
      try{ card.animate([{opacity:0, transform:'translateY(6px)'},{opacity:1, transform:'translateY(0)'}], {duration:280, easing:'cubic-bezier(.2,.9,.3,1)', delay: idx*40}); }catch(e){}
      idx++;

      const docId = h._docId || h.id || '';
      if(completionsCache[iso(currentDate)]?.[docId]) card.classList.add('done');
      const row = document.createElement('div'); row.className='habit-row';

      const check = document.createElement('div'); check.className='check'; check.style.color = h.color || selectedColor;
      if(completionsCache[iso(currentDate)]?.[docId]) check.classList.add('filled');

      // single toggle handler (debounced short) to avoid accidental double triggers
      let lastToggle = 0;
      const TOGGLE_DEBOUNCE_MS = 250;
      const doToggle = (e)=>{
        if(e && e.stopPropagation) e.stopPropagation();
        const now = Date.now();
        if(now - lastToggle < TOGGLE_DEBOUNCE_MS) return; // ignore rapid double events
        lastToggle = now;
        toggleDone(docId);
        animateDoneVisual(card,check,docId);
      };
      check.addEventListener('click', doToggle, {passive:true});

      // enable swipe on the row ‚Äî action uses same single function
      enableSwipe(row, ()=>{ doToggle(); });

      const icon = document.createElement('div'); icon.className='icon'; icon.textContent = h.icon || 'üèÉ'; icon.style.background = (h.color||selectedColor)+'22';
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<div class='title'>${escapeHtml(h.name)}</div><div class='time'>${h.start? h.start : ''}${h.end? ' ‚Äî '+h.end : ''}</div>`;
      if(completionsCache[iso(currentDate)]?.[docId]) meta.classList.add('done');

      const del = document.createElement('button'); del.className='btn-del'; del.textContent='Usu≈Ñ';
      del.onclick = (e)=>{ e.stopPropagation(); showDeleteModal(h, card); };

      row.append(check, icon, meta, del);
      card.appendChild(row);
      if(h.desc){ const ex = document.createElement('div'); ex.className='habit-extra'; ex.textContent = h.desc; card.appendChild(ex); }
      card.addEventListener('click', (e)=>{ const t=e.target; if(t===check||t===del) return; card.classList.toggle('expanded'); });

      list.appendChild(card);
    });
  }

  /* ========== ANIMATIONS, MOTIVATION & UI FEEDBACK ======== */
  const MOTIVATION_MSGS = [
    "≈öwietna robota! üí™",
    "Tak trzymaj! üî•",
    "Dobra robota! ‚úîÔ∏è",
    "Krok bli≈ºej celu! üéØ",
    "Robisz postƒôpy! üåü"
  ];

  function showMotivationOneShot(){
    // pick random message
    const msg = MOTIVATION_MSGS[Math.floor(Math.random()*MOTIVATION_MSGS.length)];
    if(!motivPopup) return;
    motivPopup.textContent = msg;
    motivPopup.classList.add('show');
    // small emoji burst
    spawnEmojiBurst();
    setTimeout(()=>{ motivPopup.classList.remove('show'); }, 1200);
  }

  function spawnEmojiBurst(){
    // simple floating emoji particles near bottom of popup
    const emojis = ['‚ú®','üéâ','‚≠ê','üí•','üëè'];
    const container = document.body;
    for(let i=0;i<6;i++){
      const el = document.createElement('div');
      el.textContent = emojis[Math.floor(Math.random()*emojis.length)];
      el.style.position='fixed';
      el.style.left = (50 + (Math.random()*160 - 80)) + '%';
      el.style.bottom = (160 + Math.random()*30) + 'px';
      el.style.transform = `translateX(-50%)`;
      el.style.fontSize = (12 + Math.random()*16) + 'px';
      el.style.opacity = '1';
      el.style.zIndex = 999;
      document.body.appendChild(el);
      const vy = 1 + Math.random()*2;
      el.animate([
        { transform: `translateX(-50%) translateY(0)`, opacity:1 },
        { transform: `translateX(-50%) translateY(-60px)`, opacity:0 }
      ], { duration: 900 + Math.random()*400, easing: 'cubic-bezier(.2,.9,.3,1)'});
      setTimeout(()=>{ try{ el.remove(); }catch(e){} }, 1400);
    }
  }

  function animateDoneVisual(card,check,id){
    const filled = !!(completionsCache[iso(currentDate)]?.[id]);
    if(filled){
      check.classList.add('filled');
      try{ check.animate([{transform:'scale(1)'},{transform:'scale(1.26)'},{transform:'scale(1)'}],{duration:420,easing:'cubic-bezier(.2,.9,.3,1)'}); }catch(e){}
      try{ card.animate([{transform:'translateY(0)'},{transform:'translateY(-8px)'},{transform:'translateY(0)'}],{duration:520,easing:'cubic-bezier(.2,.9,.3,1)'}); }catch(e){}
      card.classList.add('flash-done');
      setTimeout(()=>card.classList.remove('flash-done'),900);
      // show motivational popup
      showMotivationOneShot();
    } else {
      check.classList.remove('filled');
      card.classList.remove('flash-done');
    }
  }

  /* ========== SWIPE SUPPORT (IMPROVED) ======== */
  function enableSwipe(el, action){
    let sx=0,cx=0,drag=false, isMouse=false;
    const onTouchStart = (e)=>{ drag=true; isMouse=false; sx = e.touches[0].clientX; el.style.transition='none'; };
    const onTouchMove = (e)=>{ if(!drag) return; cx = e.touches[0].clientX - sx; if(cx<0) cx=0; el.style.transform = `translateX(${cx}px)`; };
    const onTouchEnd = ()=>{ el.style.transition='transform 320ms cubic-bezier(.2,.9,.3,1)'; el.style.transform='translateX(0)'; if(cx>90) action(); drag=false; cx=0; };

    const onMouseDown = (e)=>{ drag=true; isMouse=true; sx=e.clientX; el.style.transition='none'; };
    const onMouseMove = (e)=>{ if(!drag || !isMouse) return; cx = e.clientX - sx; if(cx<0) cx=0; el.style.transform = `translateX(${cx}px)`; };
    const onMouseUp = ()=>{ if(!drag) return; drag=false; isMouse=false; el.style.transition='transform 320ms cubic-bezier(.2,.9,.3,1)'; el.style.transform='translateX(0)'; if(cx>90) action(); cx=0; };

    el.addEventListener('touchstart', onTouchStart, {passive:true});
    el.addEventListener('touchmove', onTouchMove, {passive:true});
    el.addEventListener('touchend', onTouchEnd, {passive:true});

    el.addEventListener('mousedown', onMouseDown);
    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);
  }

  /* ========== ADD HABIT UI ======== */
  openAddBtn.onclick = ()=>{ modalBackdrop.style.display='flex'; habitNameInput.value=''; habitDescInput.value=''; document.getElementById('recurrence').value='once'; weekSelect.style.display='none'; selectedDays=[]; [...weekSelect.children].forEach(n=>n.classList.remove('active')); };
  cancelAdd.onclick = ()=> modalBackdrop.style.display='none';

  saveAdd.onclick = async ()=>{
    try{
      const u = auth.currentUser;
      if(!u) return alert('Zaloguj siƒô aby dodawaƒá nawyki.');

      const name = habitNameInput.value.trim() || 'Nawyk';
      const desc = habitDescInput.value.trim() || '';
      const start = startTimeInput.value || '';
      const end = endTimeInput.value || '';
      const rec = recurrence.value || 'once';
      const base = { name, desc, icon: selectedIcon, color: selectedColor, start, end, recurrence: rec, exclusions: [] };
      if(rec==='once') base.date = iso(currentDate);
      if(rec==='repeat') base.days = [...selectedDays];
      if(rec==='daily') base.days=[0,1,2,3,4,5,6];

      // write to server directly
      await addHabitToServer(base);
      modalBackdrop.style.display='none';
      // onSnapshot will update UI
    }catch(e){
      console.error('saveAdd err', e);
      alert('B≈ÇƒÖd zapisu: ' + (e.message||e));
    }
  };

  /* ========== COMPLETION TOGGLE (optimistic) ======== */
  function toggleDone(habitDocId){
    try{
      const u = auth.currentUser;
      if(!u){ return alert('Zaloguj siƒô, aby oznaczaƒá wykonanie.'); }
      const dateIso = iso(currentDate);

      // prepare maps
      completionsCache[dateIso] = completionsCache[dateIso] || {};
      optimisticCompletions[dateIso] = optimisticCompletions[dateIso] || {};

      // optimistic flip
      const newVal = !completionsCache[dateIso][habitDocId];
      completionsCache[dateIso][habitDocId] = newVal;
      optimisticCompletions[dateIso][habitDocId] = newVal;

      // reflect immediately
      renderDay();

      // send to server
      toggleCompletionServer(habitDocId, dateIso).catch(err=>{
        console.error('toggle comp error', err);
        // on error, revert optimistic change (best-effort)
        optimisticCompletions[dateIso][habitDocId] = serverCompletions[dateIso]?.[habitDocId] ?? undefined;
        // rebuild merged view
        completionsCache = mergeServerAndOptimistic(serverCompletions, optimisticCompletions);
        renderDay();
        alert('B≈ÇƒÖd zapisu wykonania.');
      });
    }catch(e){ console.error(e); }
  }

  /* ========== DELETE CONFIRM MODAL ======== */
  let deleteContext = null;
  function showDeleteModal(h, element){
    deleteContext = { h, element };
    confirmTitle.textContent = `Usu≈Ñ nawyk "${h.name}"?`;
    confirmText.textContent = h.recurrence === 'once' ? 'UsunƒÖƒá ten nawyk?' : 'Usu≈Ñ tylko dzi≈õ (wyjƒÖtek) czy na sta≈Çe?';
    confirmBtns.innerHTML = '';
    const btnCancel = document.createElement('button'); btnCancel.className='cbtn cbtn-cancel'; btnCancel.innerHTML='<span class="small-ico">‚úñ</span>Anuluj';
    btnCancel.onclick = ()=>{ confirmBackdrop.style.display='none'; deleteContext=null; };
    confirmBtns.appendChild(btnCancel);

    if(h.recurrence === 'once'){
      const btnDelete = document.createElement('button'); btnDelete.className='cbtn cbtn-all'; btnDelete.innerHTML='<span class="small-ico">üóëÔ∏è</span>Usu≈Ñ';
      btnDelete.onclick = async ()=>{
        confirmBackdrop.style.display='none';
        try{
          if(!h._docId) throw new Error('Brak id dokumentu - nie mo≈ºna usunƒÖƒá.');
          await deleteHabitOnServer(h._docId);
        }catch(e){ console.error(e); alert('B≈ÇƒÖd usuwania'); }
        deleteContext=null;
      };
      confirmBtns.appendChild(btnDelete);
    } else {
      const btnOnly = document.createElement('button'); btnOnly.className='cbtn cbtn-only'; btnOnly.innerHTML='<span class="small-ico">üóìÔ∏è</span>Tylko dzi≈õ';
      btnOnly.onclick = async ()=>{
        confirmBackdrop.style.display='none';
        const dayIso = iso(currentDate);
        try{
          if(!h._docId) throw new Error('Brak id dokumentu - nie mo≈ºna dodaƒá wyjƒÖtku.');
          await addExclusionOnServer(h._docId, dayIso);
        }catch(e){ console.error(e); alert('B≈ÇƒÖd'); }
        deleteContext=null;
      };
      const btnAll = document.createElement('button'); btnAll.className='cbtn cbtn-all'; btnAll.innerHTML='<span class="small-ico">üóëÔ∏è</span>Usu≈Ñ na sta≈Çe';
      btnAll.onclick = async ()=>{
        confirmBackdrop.style.display='none';
        try{
          if(!h._docId) throw new Error('Brak id dokumentu - nie mo≈ºna usunƒÖƒá.');
          await deleteHabitOnServer(h._docId);
        }catch(e){ console.error(e); alert('B≈ÇƒÖd'); }
        deleteContext=null;
      };
      confirmBtns.appendChild(btnOnly); confirmBtns.appendChild(btnAll);
    }
    confirmBackdrop.style.display='flex';
  }

  /* ========== AUTH LISTENER & START SYNC ======== */
  onAuthStateChanged(auth, async (u)=>{
    console.log('onAuthStateChanged:', u ? u.uid : null);
    renderAuthUI();
    if(u){
      // start realtime sync for this user
      startRealtimeSync(u.uid);
    } else {
      // stop listeners & clear caches
      if(typeof unsubHab === 'function') try{ unsubHab(); }catch(e){}
      if(typeof unsubComp === 'function') try{ unsubComp(); }catch(e){}
      habitsCache = [];
      serverCompletions = {};
      optimisticCompletions = {};
      completionsCache = {};
      renderAll();
    }
  });

  /* ========== NAV BAR (bottom) ======== */
  function setActiveNav(el){
    [navHome, navEvents, navSettings].forEach(n=>n.classList.remove('active'));
    if(el) el.classList.add('active');
  }
  navHome.onclick = ()=>{ setActiveNav(navHome); /* stay on home */ };
  navEvents.onclick = ()=>{ setActiveNav(navEvents); window.location.href = 'events.html'; };
  navSettings.onclick = ()=>{ setActiveNav(navSettings); window.location.href = 'settings.html'; };

  /* ========== RENDER ALL ======== */
  function renderAll(){ renderTodayDate(); renderWeekBar(); renderDay(); renderAuthUI(); }
  renderAll();

  /* ========== SERVICE WORKER (optional) ======== */
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').then(()=>console.log('sw registered')).catch(()=>{});
  }

  /* ========== SMALL HELPERS ========== */
  function escapeHtml(s){
    if(!s) return '';
    return s.replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }


  </script>

</body>
</html>
