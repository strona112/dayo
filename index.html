<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HabitMaster ‚Äî Dayo (Firebase)</title>
  <meta name="theme-color" content="#071428" />
  <style>
    :root{
      --bg:#071022; --muted:#9bb0cf; --glass:rgba(255,255,255,0.03);
      --accent1:#7c3aed; --accent2:#06b6d4; --radius:14px;
      --shadow:0 14px 36px rgba(2,6,23,0.6);
      --fast:180ms; --mid:320ms; --slow:520ms;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071022 0%, #041428 100%);color:#eaf3ff;-webkit-font-smoothing:antialiased}
    .header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(255,255,255,0.02);position:sticky;top:0;z-index:40}
    .today-date{font-weight:700}
    .user-bubble{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:13px}
    .sign-btn{background:none;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;color:var(--muted);cursor:pointer}

    .weekbar{display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(255,255,255,0.02);backdrop-filter:blur(6px);box-shadow:var(--shadow);position:sticky;top:56px;z-index:30}
    .week-arrow{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:rgba(255,255,255,0.03);cursor:pointer}
    .week-strip{display:flex;flex:1;gap:8px}
    .week-col{flex:1;text-align:center;font-size:12px;color:var(--muted);cursor:pointer;padding:8px;border-radius:10px;transition:all var(--mid)}
    .week-col .num{display:block;font-size:18px;font-weight:700;color:#fff}
    .week-col.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;transform:translateY(-4px);box-shadow:0 8px 22px rgba(12,30,100,0.45)}

    .app{padding:16px;padding-bottom:140px}
    .habit-card{display:flex;align-items:center;gap:12px;padding:14px;border-radius:12px;background:rgba(255,255,255,0.02);box-shadow:0 6px 20px rgba(0,0,0,0.5);margin-bottom:12px;transition:transform var(--mid),opacity var(--mid),filter var(--mid);touch-action:pan-y;overflow:hidden}
    .habit-card.done{opacity:.5;filter:grayscale(.2);text-decoration:line-through}
    .habit-row{display:flex;align-items:center;gap:12px;width:100%}
    .check{width:36px;height:36px;border-radius:50%;border:2px solid currentColor;display:grid;place-items:center;cursor:pointer;flex-shrink:0;transition:all var(--mid)}
    .check.filled{background:currentColor;box-shadow:0 10px 24px rgba(0,0,0,0.45);transform:scale(1.18)}
    .icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;background:rgba(255,255,255,0.02)}
    .meta{flex:1;min-width:0;display:flex;flex-direction:column}
    .title{font-weight:700;font-size:15px}
    .time{font-size:13px;color:var(--muted)}
    .btn-del{border:1px solid rgba(255,255,255,0.06);background:none;color:var(--muted);padding:6px 10px;border-radius:10px;font-size:13px;cursor:pointer}
    .habit-extra{font-size:13px;color:#b7cde6;padding:8px 6px 0 6px;display:none}
    .habit-card.expanded .habit-extra{display:block}

    .fab{position:fixed;right:18px;bottom:96px;width:64px;height:64px;border-radius:50%;display:grid;place-items:center;font-size:30px;background:linear-gradient(135deg,var(--accent1),var(--accent2));border:none;color:white;box-shadow:var(--shadow);cursor:pointer}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
    .modal{width:100%;max-width:540px;background:#071428;border-radius:14px;padding:16px;box-shadow:var(--shadow);max-height:84vh;overflow:auto}
    .icon-grid,.color-grid{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
    .icon-choice{width:48px;height:48px;border-radius:12px;background:#071a2b;display:grid;place-items:center;font-size:22px;cursor:pointer;transition:transform .16s}
    .icon-choice.active{outline:3px solid rgba(255,255,255,0.06);transform:scale(1.12)}
    .color-choice{width:36px;height:36px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:transform .2s}
    .color-choice.active{box-shadow:0 6px 18px rgba(0,0,0,0.5);transform:translateY(-4px)}

    .confirm-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:70}
    .confirm-box{background:#071428;border-radius:14px;padding:18px;box-shadow:var(--shadow);width:92%;max-width:420px;color:white;text-align:center}
    .confirm-title{font-weight:700;margin-bottom:6px}
    .confirm-text{color:#b7cde6;font-size:14px}
    .confirm-btns{display:flex;gap:12px;margin-top:16px}
    .cbtn{flex:1;padding:12px;border-radius:12px;font-weight:700;border:none;cursor:pointer}
    .cbtn-cancel{background:rgba(255,255,255,0.04);color:#eaf3ff}
    .cbtn-only{background:rgba(255,255,255,0.06);color:#eaf3ff}
    .cbtn-all{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff}

    .login-panel{padding:18px;display:flex;flex-direction:column;gap:8px}
    .small{font-size:13px;padding:8px 10px;border-radius:10px}
    .email-input{padding:10px;border-radius:10px;border:none;background:#0b1220;color:white}
    .link-like{background:none;border:0;color:var(--accent2);cursor:pointer}
    .status-row{display:flex;gap:8px;align-items:center}
    .flash-done{animation:flashDone var(--slow) ease both}
    @keyframes flashDone{0%{box-shadow:0 0 0 rgba(0,0,0,0);transform:translateY(0)}30%{transform:translateY(-6px) scale(1.02)}60%{transform:translateY(0) scale(1)}100%{box-shadow:0 18px 40px rgba(0,0,0,0.45)}}
    .small-ico{font-size:14px;margin-right:6px}
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <div class="left">
      <div class="today-date" id="todayDate">...</div>
    </div>
    <div class="status-row" id="authRow">
      <button id="btnSignIn" class="sign-btn">Zaloguj</button>
    </div>
  </div>

  <!-- WEEK BAR -->
  <div class="weekbar">
    <div class="week-arrow" id="prevWeek">‚óÄ</div>
    <div class="week-strip" id="weekBar"></div>
    <div class="week-arrow" id="nextWeek">‚ñ∂</div>
  </div>

  <!-- APP -->
  <div class="app" id="dayView">
    <div id="habitsList"></div>
    <div id="emptyState" style="opacity:.6;text-align:center;margin-top:20px">Brak nawyk√≥w</div>
  </div>

  <!-- FAB -->
  <button class="fab" id="openAdd" title="Dodaj nawyk">Ôºã</button>

  <!-- ADD MODAL (scrollable) -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" id="addModal">
      <h3 style="margin:6px 0">Dodaj nawyk</h3>

      <label>Nazwa</label>
      <input id="habitName" placeholder="Np. ƒÜwiczenia" style="width:100%;padding:10px;border-radius:10px;background:#041826;color:white;border:none;margin:8px 0" />

      <label>Opis (opcjonalnie)</label>
      <textarea id="habitDesc" placeholder="Kr√≥tki opis..." style="width:100%;padding:10px;border-radius:10px;background:#041826;color:white;border:none;margin:8px 0;height:70px"></textarea>

      <label>Ikona</label>
      <div class="icon-grid" id="iconGrid"></div>

      <label>Kolor</label>
      <div class="color-grid" id="colorGrid"></div>

      <label>Powtarzanie</label>
      <select id="recurrence" style="width:100%;padding:10px;border-radius:10px;background:#041826;color:white;border:none;margin:8px 0">
        <option value="once">Tylko dzi≈õ</option>
        <option value="daily">Codziennie</option>
        <option value="repeat">PowtarzajƒÖce siƒô</option>
      </select>

      <div id="weekSelect" style="display:none" class="icon-grid"></div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1">
          <label>Start</label>
          <input type="time" id="startTime" style="width:100%;padding:10px;border-radius:10px;background:#041826;color:white;border:none;margin-top:6px" />
        </div>
        <div style="flex:1">
          <label>Koniec</label>
          <input type="time" id="endTime" style="width:100%;padding:10px;border-radius:10px;background:#041826;color:white;border:none;margin-top:6px" />
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="saveAdd" style="flex:1;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;font-size:16px;cursor:pointer">Dodaj nawyk</button>
        <button id="cancelAdd" style="flex:0 0 60px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:none;color:var(--muted);">Anuluj</button>
      </div>
    </div>
  </div>

  <!-- CONFIRM DELETE (custom) -->
  <div class="confirm-backdrop" id="confirmBackdrop">
    <div class="confirm-box" id="confirmBox" role="dialog" aria-modal="true">
      <div class="confirm-title" id="confirmTitle">Usu≈Ñ nawyk?</div>
      <div class="confirm-text" id="confirmText">Co zrobiƒá z tym nawykiem?</div>
      <div class="confirm-btns" id="confirmBtns"></div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal-backdrop" id="authBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 style="margin:6px 0">Zaloguj siƒô</h3>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <button id="googleSign" class="small" style="flex:1;padding:10px;border-radius:10px;border:none;background:#4285f4;color:white">Zaloguj przez Google</button>
        <button id="showEmail" class="small" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:none;color:var(--muted)">Email</button>
      </div>

      <div id="emailForm" style="display:none;flex-direction:column;gap:8px">
        <input id="emailInput" class="email-input" placeholder="Email" style="width:100%;padding:10px;border-radius:10px;background:#041826;color:white;border:none" />
        <input id="passInput" class="email-input" placeholder="Has≈Ço" type="password" style="width:100%;padding:10px;border-radius:10px;background:#041826;color:white;border:none" />
        <div style="display:flex;gap:8px">
          <button id="emailSignUp" class="small" style="flex:1;padding:10px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white">Zarejestruj</button>
          <button id="emailSignIn" class="small" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:none;color:var(--muted)">Zaloguj</button>
        </div>
      </div>

      <div style="font-size:13px;color:#9fb2d1;margin-top:6px">Zaloguj siƒô aby synchronizowaƒá nawyki miƒôdzy urzƒÖdzeniami.</div>
      <button id="authClose" class="link-like" style="margin-top:10px">Zamknij</button>
    </div>
  </div>

  <!-- FIREBASE SDK (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    import {
      getFirestore,
      collection,
      query,
      where,
      onSnapshot,
      addDoc,
      doc,
      updateDoc,
      deleteDoc,
      setDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    /* ========== CONFIG ========== */
    const firebaseConfig = {
      apiKey: "AIzaSyDkTe80eNt90_mM-f5zNWiGzACrWymzM-w",
      authDomain: "dayo-e3b32.firebaseapp.com",
      projectId: "dayo-e3b32",
      storageBucket: "dayo-e3b32.firebasestorage.app",
      messagingSenderId: "971722853532",
      appId: "1:971722853532:web:d13bc8493764d5da347159",
      measurementId: "G-0LXNQBVZWR"
    };

    /* ========== INIT ========== */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    /* ========== STATE & HELPERS ========== */
    const DAY_NAMES = ['pon','wt','≈õr','czw','pt','sob','nd'];
    let today = new Date(); today.setHours(0,0,0,0);
    let currentDate = new Date(); currentDate.setHours(0,0,0,0);
    let weekOffset = 0;
    let user = null;

    const todayEl = document.getElementById('todayDate');
    const weekBar = document.getElementById('weekBar');
    const habitsList = document.getElementById('habitsList');
    const emptyState = document.getElementById('emptyState');
    const openAddBtn = document.getElementById('openAdd');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const addModal = document.getElementById('addModal');
    const iconGrid = document.getElementById('iconGrid');
    const colorGrid = document.getElementById('colorGrid');
    const weekSelect = document.getElementById('weekSelect');
    const recurrence = document.getElementById('recurrence');

    const authBackdrop = document.getElementById('authBackdrop');
    const googleSign = document.getElementById('googleSign');
    const showEmail = document.getElementById('showEmail');
    const emailForm = document.getElementById('emailForm');
    const emailInput = document.getElementById('emailInput');
    const passInput = document.getElementById('passInput');
    const emailSignUp = document.getElementById('emailSignUp');
    const emailSignIn = document.getElementById('emailSignIn');
    const authClose = document.getElementById('authClose');
    const btnSignIn = document.getElementById('btnSignIn');
    const authRow = document.getElementById('authRow');

    const saveAdd = document.getElementById('saveAdd');
    const cancelAdd = document.getElementById('cancelAdd');
    const habitNameInput = document.getElementById('habitName');
    const habitDescInput = document.getElementById('habitDesc');
    const startTimeInput = document.getElementById('startTime');
    const endTimeInput = document.getElementById('endTime');

    const confirmBackdrop = document.getElementById('confirmBackdrop');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmText = document.getElementById('confirmText');
    const confirmBtns = document.getElementById('confirmBtns');

    // local caches used for render (kept in sync via listeners)
    let habitsCache = []; // array of habit objects
    let completionsCache = {}; // { 'YYYY-MM-DD': { habitId: true } }

    // pickers
    const ICONS = ['üèÉ','üìö','üßò','üí™','üõå','‚òï','üçé','üßπ','üö∞','üéß','üéØ','üé®','üß©','üö¥','üèä','üèãÔ∏è‚Äç‚ôÇÔ∏è','üñ•Ô∏è','‚úçÔ∏è','üìÖ','üéµ'];
    const COLORS = ['#3b82f6','#ef4444','#22c55e','#f59e0b','#a855f7','#06b6d4','#fb7185','#10b981','#f97316','#8b5cf6','#0ea5a4','#f43f5e'];
    let selectedIcon = ICONS[0];
    let selectedColor = COLORS[0];
    let selectedDays = [];

    function iso(d){ return d.toISOString().slice(0,10); }
    function dayIdxFromDate(d){ return (d.getDay()+6)%7; } // Mon=0..Sun=6

    /* ========== UI: Week bar & Today ======== */
    function renderTodayDate(){
      const opts={day:'numeric',month:'long',year:'numeric'};
      todayEl.textContent = today.toLocaleDateString('pl-PL',opts);
    }

    function weekStartFromOffset(){
      const base = new Date(currentDate);
      const day = base.getDay();
      const monday = new Date(base);
      monday.setDate(base.getDate() - ((day+6)%7) + weekOffset*7);
      monday.setHours(0,0,0,0);
      return monday;
    }

    function renderWeekBar(){
      weekBar.innerHTML='';
      const start = weekStartFromOffset();
      for(let i=0;i<7;i++){
        const d=new Date(start); d.setDate(start.getDate()+i);
        const col = document.createElement('div'); col.className='week-col';
        col.innerHTML = `<small>${DAY_NAMES[i]}</small><span class='num'>${d.getDate()}</span>`;
        if(iso(d) === iso(currentDate)) col.classList.add('active');
        col.onclick = ()=>{ currentDate = new Date(d); renderAll(); };
        weekBar.appendChild(col);
      }
    }
    document.getElementById('prevWeek').onclick = ()=>{ weekOffset--; renderAll(); };
    document.getElementById('nextWeek').onclick = ()=>{ weekOffset++; renderAll(); };

    /* ========== PICKERS INIT ========== */
    function initPickers(){
      iconGrid.innerHTML=''; colorGrid.innerHTML='';
      ICONS.forEach((ic,idx)=>{
        const el = document.createElement('div'); el.className='icon-choice'; el.textContent=ic;
        el.onclick = ()=>{ selectedIcon=ic; [...iconGrid.children].forEach(x=>x.classList.remove('active')); el.classList.add('active'); };
        iconGrid.appendChild(el); if(idx===0) el.classList.add('active');
      });
      COLORS.forEach((c,idx)=>{
        const el = document.createElement('div'); el.className='color-choice'; el.style.background=c;
        el.onclick = ()=>{ selectedColor=c; [...colorGrid.children].forEach(x=>x.classList.remove('active')); el.classList.add('active'); };
        colorGrid.appendChild(el); if(idx===0) el.classList.add('active');
      });
      // weekSelect (days)
      weekSelect.innerHTML=''; DAY_NAMES.forEach((d,i)=>{
        const b=document.createElement('div'); b.className='icon-choice'; b.style.width='44px'; b.style.height='44px'; b.textContent=d;
        b.onclick = ()=>{ if(selectedDays.includes(i)) selectedDays = selectedDays.filter(x=>x!==i); else selectedDays.push(i); b.classList.toggle('active'); };
        weekSelect.appendChild(b);
      });
    }
    initPickers();

    /* show/hide repeat days */
    recurrence.onchange = (e)=> {
      weekSelect.style.display = e.target.value === 'repeat' ? 'flex' : 'none';
      if(e.target.value === 'daily'){ selectedDays = [0,1,2,3,4,5,6]; [...weekSelect.children].forEach(n=>n.classList.add('active')); }
      if(e.target.value !== 'repeat'){ selectedDays = []; [...weekSelect.children].forEach(n=>n.classList.remove('active')); }
    };

    /* ========== AUTH UI & flows ========== */
    function renderAuthUI(){
      authRow.innerHTML = '';
      if(user){
        const span = document.createElement('div'); span.className='user-bubble'; span.textContent = user.email || user.displayName || 'User';
        const btn = document.createElement('button'); btn.className='sign-btn'; btn.textContent='Wyloguj';
        btn.onclick = ()=> signOut(auth);
        authRow.append(span, btn);
      } else {
        const btn = document.createElement('button'); btn.id='btnSignInLocal'; btn.className='sign-btn'; btn.textContent='Zaloguj';
        btn.onclick = ()=> authBackdrop.style.display='flex';
        authRow.append(btn);
      }
    }

    btnSignIn.onclick = ()=> authBackdrop.style.display='flex';
    authClose.onclick = ()=> authBackdrop.style.display='none';
    showEmail.onclick = ()=> { emailForm.style.display = 'flex'; };

    googleSign.onclick = async ()=>{
      try{ await signInWithPopup(auth, provider); authBackdrop.style.display='none'; } catch(e){ console.error(e); alert('B≈ÇƒÖd logowania Google: '+(e.message||e)); }
    };

    emailSignUp.onclick = async ()=>{
      const email = emailInput.value.trim(); const pass = passInput.value;
      if(!email || !pass) return alert('Wpisz email i has≈Ço');
      try{ await createUserWithEmailAndPassword(auth,email,pass); authBackdrop.style.display='none'; } catch(e){ alert('B≈ÇƒÖd rejestracji: '+(e.message||e)); }
    };
    emailSignIn.onclick = async ()=>{
      const email = emailInput.value.trim(); const pass = passInput.value;
      if(!email || !pass) return alert('Wpisz email i has≈Ço');
      try{ await signInWithEmailAndPassword(auth,email,pass); authBackdrop.style.display='none'; } catch(e){ alert('B≈ÇƒÖd logowania: '+(e.message||e)); }
    };

    /* ========== FIRESTORE REALTIME SYNC ========== */
    let unsubHab = null, unsubComp = null;

    function startRealtimeSync(uid){
      if(unsubHab) unsubHab();
      if(unsubComp) unsubComp();

      const colRef = collection(db, `users/${uid}/habits`);
      const q = query(colRef);
      unsubHab = onSnapshot(q, snapshot=>{
        habitsCache = [];
        snapshot.forEach(ds=>{
          const data = ds.data(); data._docId = ds.id;
          habitsCache.push(data);
        });
        renderDay();
      });

      const compRef = collection(db, `users/${uid}/completions`);
      const q2 = query(compRef);
      unsubComp = onSnapshot(q2, snapshot=>{
        completionsCache = {};
        snapshot.forEach(ds=>{
          const d = ds.data();
          if(d && d.date && d.map) completionsCache[d.date] = d.map;
        });
        renderDay();
      });
    }

    /* ========== HELPERS: CRUD & completions ========== */
    async function addHabitToServer(h){
      if(!user) {
        // offline: store to localStorage fallback
        const local = JSON.parse(localStorage.getItem('hm_offline')||'[]'); local.push(h); localStorage.setItem('hm_offline', JSON.stringify(local)); return;
      }
      await addDoc(collection(db, `users/${user.uid}/habits`), {...h, createdAt: serverTimestamp()});
    }

    async function deleteHabitOnServer(docId){
      if(!user){ // offline remove local
        const local = JSON.parse(localStorage.getItem('hm_offline')||'[]').filter(x=>x.id!==docId);
        localStorage.setItem('hm_offline', JSON.stringify(local)); return;
      }
      await deleteDoc(doc(db, `users/${user.uid}/habits`, docId));
    }

    async function addExclusionOnServer(docId, dateIso){
      if(!user){
        const local = JSON.parse(localStorage.getItem('hm_offline')||'[]');
        const h = local.find(x=>x.id===docId);
        if(h){ h.exclusions = h.exclusions||[]; if(!h.exclusions.includes(dateIso)) h.exclusions.push(dateIso); localStorage.setItem('hm_offline', JSON.stringify(local)); renderDay(); }
        return;
      }
      const docRef = doc(db, `users/${user.uid}/habits`, docId);
      // read local cached copy then update
      const hLocal = habitsCache.find(x=>x._docId===docId);
      const exclusions = (hLocal?.exclusions||[]);
      if(!exclusions.includes(dateIso)) exclusions.push(dateIso);
      await updateDoc(docRef, { exclusions });
    }

    async function toggleCompletionServer(habitDocId, dateIso){
      if(!user){
        const local = JSON.parse(localStorage.getItem('hm_comps')||'{}');
        local[dateIso] = local[dateIso] || {};
        local[dateIso][habitDocId] = !local[dateIso][habitDocId];
        localStorage.setItem('hm_comps', JSON.stringify(local));
        completionsCache = local;
        renderDay();
        return;
      }
      const docId = dateIso; // we'll store documents as date string under completions collection
      const docRef = doc(db, `users/${user.uid}/completions`, docId);
      // build map from current cache
      const existing = completionsCache[dateIso] ? {...completionsCache[dateIso]} : {};
      existing[habitDocId] = !existing[habitDocId];
      await setDoc(docRef, { userId: user.uid, date: dateIso, map: existing }, { merge: true });
    }

    /* ========== RENDER DAY - uses habitsCache & completionsCache ========== */
    function matches(h,d){
      if(!h) return false;
      if(h.recurrence === 'once') return h.date === iso(d);
      if(h.recurrence === 'daily') return !(Array.isArray(h.exclusions) && h.exclusions.includes(iso(d)));
      if(h.recurrence === 'repeat'){
        const idx = dayIdxFromDate(d);
        const inDays = Array.isArray(h.days) && h.days.includes(idx);
        const excluded = Array.isArray(h.exclusions) && h.exclusions.includes(iso(d));
        return inDays && !excluded;
      }
      return false;
    }

    function renderDay(){
      const list = habitsList; list.innerHTML='';
      const items = (habitsCache||[]).filter(h=>matches(h,currentDate)).sort((a,b)=> (a.start||'').localeCompare(b.start||'') || (a.name||'').localeCompare(b.name||''));
      emptyState.style.display = items.length ? 'none' : 'block';
      items.forEach(h=>{
        const card = document.createElement('div'); card.className='habit-card';
        if(completionsCache[iso(currentDate)]?.[h._docId]) card.classList.add('done');
        const row = document.createElement('div'); row.className='habit-row';
        const check = document.createElement('div'); check.className='check'; check.style.color = h.color || selectedColor;
        if(completionsCache[iso(currentDate)]?.[h._docId]) check.classList.add('filled');
        check.onclick = (e)=>{ e.stopPropagation(); toggleDone(h._docId); animateDoneVisual(card,check,h._docId); };

        enableSwipe(row, ()=>{ toggleDone(h._docId); animateDoneVisual(card,check,h._docId); });

        const icon = document.createElement('div'); icon.className='icon'; icon.textContent = h.icon || 'üèÉ'; icon.style.background = (h.color||selectedColor)+'22';

        const meta = document.createElement('div'); meta.className='meta';
        meta.innerHTML = `<div class='title'>${h.name}</div><div class='time'>${h.start? h.start : ''}${h.end? ' ‚Äî '+h.end : ''}</div>`;
        if(completionsCache[iso(currentDate)]?.[h._docId]) meta.classList.add('done');

        const del = document.createElement('button'); del.className='btn-del'; del.textContent='Usu≈Ñ';
        del.onclick = (e)=>{ e.stopPropagation(); showDeleteModal(h, card); };

        row.append(check, icon, meta, del);
        card.appendChild(row);
        if(h.desc){ const ex = document.createElement('div'); ex.className='habit-extra'; ex.textContent = h.desc; card.appendChild(ex); }
        card.addEventListener('click', (e)=>{ const t=e.target; if(t===check||t===del) return; card.classList.toggle('expanded'); });

        list.appendChild(card);
      });
    }

    /* ========== ANIMATIONS ========== */
    function toggleDone(habitDocId){
      const dateIso = iso(currentDate);
      completionsCache[dateIso] = completionsCache[dateIso] || {};
      completionsCache[dateIso][habitDocId] = !completionsCache[dateIso][habitDocId];
      renderDay();
      toggleCompletionServer(habitDocId, dateIso).catch(err=>{ console.error('toggle comp error', err); });
    }
    function animateDoneVisual(card,check,id){
      const filled = !!completionsCache[iso(currentDate)]?.[id];
      if(filled){ check.classList.add('filled'); card.classList.add('flash-done'); setTimeout(()=>card.classList.remove('flash-done'),900); try{ check.animate([{transform:'scale(1)'},{transform:'scale(1.26)'},{transform:'scale(1)'}],{duration:520,easing:'cubic-bezier(.2,.9,.3,1)'}); }catch(e){} } else { check.classList.remove('filled'); card.classList.remove('flash-done'); }
    }

    /* ========== SWIPE SUPPORT ========== */
    function enableSwipe(el, action){
      let sx=0,cx=0,drag=false;
      el.addEventListener('touchstart', e=>{ drag=true; sx = e.touches[0].clientX; el.style.transition='none'; });
      el.addEventListener('touchmove', e=>{ if(!drag) return; cx = e.touches[0].clientX - sx; if(cx<0) cx=0; el.style.transform = `translateX(${cx}px)`; });
      el.addEventListener('touchend', ()=>{ el.style.transition='transform 320ms cubic-bezier(.2,.9,.3,1)'; el.style.transform='translateX(0)'; if(cx>90) action(); drag=false; cx=0; });
      let md=false;
      el.addEventListener('mousedown', e=>{ md=true; sx=e.clientX; el.style.transition='none'; });
      window.addEventListener('mousemove', e=>{ if(!md) return; cx = e.clientX - sx; if(cx<0) cx=0; el.style.transform = `translateX(${cx}px)`; });
      window.addEventListener('mouseup', ()=>{ if(!md) return; md=false; el.style.transition='transform 320ms cubic-bezier(.2,.9,.3,1)'; el.style.transform='translateX(0)'; if(cx>90) action(); cx=0; });
    }

    /* ========== ADD HABIT UI ========== */
    openAddBtn.onclick = ()=>{ modalBackdrop.style.display='flex'; habitNameInput.value=''; habitDescInput.value=''; document.getElementById('recurrence').value='once'; weekSelect.style.display='none'; selectedDays=[]; [...weekSelect.children].forEach(n=>n.classList.remove('active')); };
    cancelAdd.onclick = ()=> modalBackdrop.style.display='none';

    saveAdd.onclick = async ()=>{
      const name = habitNameInput.value.trim() || 'Nawyk';
      const desc = habitDescInput.value.trim() || '';
      const start = startTimeInput.value || '';
      const end = endTimeInput.value || '';
      const rec = recurrence.value || 'once';
      const h = { name, desc, icon: selectedIcon, color: selectedColor, start, end, recurrence: rec, exclusions: [] };
      if(rec==='once') h.date = iso(currentDate);
      if(rec==='repeat') h.days = [...selectedDays];
      if(rec==='daily') h.days=[0,1,2,3,4,5,6];
      // optimistic UI
      // temporary id
      h._tempId = Date.now().toString(36);
      habitsCache.push(h);
      renderDay();
      modalBackdrop.style.display='none';
      // server
      try{ await addHabitToServer(h); } catch(e){ console.error('add habit err', e); alert('B≈ÇƒÖd zapisu'); }
    };

    /* ========== DELETE CONFIRM MODAL ========== */
    let deleteContext = null;
    function showDeleteModal(h, element){
      deleteContext = { h, element };
      confirmTitle.textContent = `Usu≈Ñ nawyk "${h.name}"?`;
      confirmText.textContent = h.recurrence === 'once' ? 'UsunƒÖƒá ten nawyk?' : 'Usu≈Ñ tylko dzi≈õ (wyjƒÖtek) czy na sta≈Çe?';
      confirmBtns.innerHTML = '';
      const btnCancel = document.createElement('button'); btnCancel.className='cbtn cbtn-cancel'; btnCancel.innerHTML='<span class="small-ico">‚úñ</span>Anuluj';
      btnCancel.onclick = ()=>{ confirmBackdrop.style.display='none'; deleteContext=null; };
      confirmBtns.appendChild(btnCancel);

      if(h.recurrence === 'once'){
        const btnDelete = document.createElement('button'); btnDelete.className='cbtn cbtn-all'; btnDelete.innerHTML='<span class="small-ico">üóëÔ∏è</span>Usu≈Ñ';
        btnDelete.onclick = async ()=>{
          confirmBackdrop.style.display='none';
          if(user && h._docId){ await deleteHabitOnServer(h._docId); }
          else { habitsCache = habitsCache.filter(x=>x._tempId !== h._tempId); localStorage.setItem('hm_offline', JSON.stringify(habitsCache)); }
          renderDay(); deleteContext=null;
        };
        confirmBtns.appendChild(btnDelete);
      } else {
        const btnOnly = document.createElement('button'); btnOnly.className='cbtn cbtn-only'; btnOnly.innerHTML='<span class="small-ico">üóìÔ∏è</span>Tylko dzi≈õ';
        btnOnly.onclick = async ()=>{
          confirmBackdrop.style.display='none';
          const dayIso = iso(currentDate);
          if(user && h._docId){ await addExclusionOnServer(h._docId, dayIso); }
          else { h.exclusions = h.exclusions || []; if(!h.exclusions.includes(dayIso)) h.exclusions.push(dayIso); localStorage.setItem('hm_offline', JSON.stringify(habitsCache)); }
          renderDay(); deleteContext=null;
        };
        const btnAll = document.createElement('button'); btnAll.className='cbtn cbtn-all'; btnAll.innerHTML='<span class="small-ico">üóëÔ∏è</span>Usu≈Ñ na sta≈Çe';
        btnAll.onclick = async ()=>{
          confirmBackdrop.style.display='none';
          if(user && h._docId) { await deleteHabitOnServer(h._docId); }
          else { habitsCache = habitsCache.filter(x=>x._tempId !== h._tempId); localStorage.setItem('hm_offline', JSON.stringify(habitsCache)); }
          renderDay(); deleteContext=null;
        };
        confirmBtns.appendChild(btnOnly); confirmBtns.appendChild(btnAll);
      }
      confirmBackdrop.style.display='flex';
    }

    /* ========== AUTH LISTENER ========== */
    onAuthStateChanged(auth, (u)=>{
      user = u;
      renderAuthUI();
      if(user){
        startRealtimeSync(user.uid);
      } else {
        if(typeof unsubHab === 'function') unsubHab();
        if(typeof unsubComp === 'function') unsubComp();
        // load offline fallback
        habitsCache = JSON.parse(localStorage.getItem('hm_offline')||'[]');
        completionsCache = JSON.parse(localStorage.getItem('hm_comps')||'{}');
        renderAll();
      }
    });

    /* ========== RENDER ALL ======== */
    function renderAll(){ renderTodayDate(); renderWeekBar(); renderDay(); renderAuthUI(); }
    renderAll();

    /* ========== SERVICE WORKER (optional) ======== */
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js').then(()=>console.log('sw registered')).catch(()=>{});
    }
  </script>
</body>
</html>
