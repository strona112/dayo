<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signOut,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    setPersistence,
    browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  import {
    getFirestore,
    collection,
    query,
    onSnapshot,
    addDoc,
    doc,
    updateDoc,
    deleteDoc,
    setDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  /* ========== CONFIG ========== */
  const firebaseConfig = {
    apiKey: "AIzaSyDkTe80eNt90_mM-f5zNWiGzACrWymzM-w",
    authDomain: "dayo-e3b32.firebaseapp.com",
    projectId: "dayo-e3b32",
    storageBucket: "dayo-e3b32.firebasestorage.app",
    messagingSenderId: "971722853532",
    appId: "1:971722853532:web:d13bc8493764d5da347159",
    measurementId: "G-0LXNQBVZWR"
  };

  /* ========== INIT ========== */
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // Ensure auth persistence in browser (so user stays logged in after closing)
  setPersistence(auth, browserLocalPersistence).catch(err => {
    console.warn('setPersistence failed:', err);
  });

  /* ========== STATE & HELPERS ========== */
  const DAY_NAMES = ['pon','wt','Å›r','czw','pt','sob','nd'];
  let today = new Date(); today.setHours(0,0,0,0);
  let currentDate = new Date(); currentDate.setHours(0,0,0,0);
  let weekOffset = 0;

  const todayEl = document.getElementById('todayDate');
  const weekBar = document.getElementById('weekBar');
  const habitsList = document.getElementById('habitsList');
  const emptyState = document.getElementById('emptyState');
  const openAddBtn = document.getElementById('openAdd');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const iconGrid = document.getElementById('iconGrid');
  const colorGrid = document.getElementById('colorGrid');
  const weekSelect = document.getElementById('weekSelect');
  const recurrence = document.getElementById('recurrence');

  const authBackdrop = document.getElementById('authBackdrop');
  const googleSign = document.getElementById('googleSign');
  const showEmail = document.getElementById('showEmail');
  const emailForm = document.getElementById('emailForm');
  const emailInput = document.getElementById('emailInput');
  const passInput = document.getElementById('passInput');
  const emailSignUp = document.getElementById('emailSignUp');
  const emailSignIn = document.getElementById('emailSignIn');
  const authClose = document.getElementById('authClose');
  const btnSignIn = document.getElementById('btnSignIn');
  const authRow = document.getElementById('authRow');

  const saveAdd = document.getElementById('saveAdd');
  const cancelAdd = document.getElementById('cancelAdd');
  const habitNameInput = document.getElementById('habitName');
  const habitDescInput = document.getElementById('habitDesc');
  const startTimeInput = document.getElementById('startTime');
  const endTimeInput = document.getElementById('endTime');

  const confirmBackdrop = document.getElementById('confirmBackdrop');
  const confirmTitle = document.getElementById('confirmTitle');
  const confirmText = document.getElementById('confirmText');
  const confirmBtns = document.getElementById('confirmBtns');

  const motivPopup = document.getElementById('motivPopup');
  const navHome = document.getElementById('navHome');
  const navEvents = document.getElementById('navEvents');
  const navSettings = document.getElementById('navSettings');

  // caches populated from Firestore snapshots
  let habitsCache = [];
  let completionsCache = {}; // merged view (server merged with optimistic)
  let serverCompletions = {}; // last received from server

  // optimistic local toggles: { 'YYYY-MM-DD': { habitId: true/false } }
  let optimisticCompletions = {};

  // pickers - expanded icon set
  const ICONS = [
    'ğŸƒ','ğŸš¿','ğŸš´','ğŸŠ','ğŸ‹ï¸â€â™‚ï¸','ğŸ§˜','ğŸ›Œ','â˜•','ğŸ','ğŸ½ï¸','ğŸ§¹','ğŸ§º','ğŸ§»','ğŸ§¼',
    'ğŸª¥','ğŸ’Š','ğŸ“š','âœï¸','ğŸ–¥ï¸','ğŸ“…','ğŸµ','ğŸ§','ğŸ¯','ğŸ¨','ğŸ§©','ğŸ’¼','ğŸ›’','ğŸš—','ğŸŒ±','ğŸ§‘â€ğŸ³','ğŸª´','ğŸ”§','ğŸª‘','ğŸ§¯','ğŸ› ï¸','ğŸ§‘â€ğŸ”¬','ğŸ§‘â€ğŸ«'
  ];
  const COLORS = ['#3b82f6','#ef4444','#22c55e','#f59e0b','#a855f7','#06b6d4','#fb7185','#10b981','#f97316','#8b5cf6','#0ea5a4','#f43f5e'];
  let selectedIcon = ICONS[0];
  let selectedColor = COLORS[0];
  let selectedDays = [];

  function iso(d){ return d.toISOString().slice(0,10); }
  function dayIdxFromDate(d){ return (d.getDay()+6)%7; } // Mon=0..Sun=6

  /* ========== INJECT MINIMAL STYLES FOR ANIMATIONS (safe to include in script) ======== */
  (function injectStyles(){
    const s = document.createElement('style');
    s.textContent = `
      /* small helpers used by animation code */
      .flash-done { box-shadow: 0 6px 30px rgba(0,0,0,0.12); transform-origin: center; }
      .habit-card { transition: transform .28s cubic-bezier(.2,.9,.3,1), box-shadow .28s; will-change: transform, box-shadow; overflow: visible; position: relative; }
      .check { transition: transform .26s cubic-bezier(.2,.9,.3,1), background-color .2s, color .2s; will-change: transform; cursor: pointer; display:flex; align-items:center; justify-content:center; }
      .check.filled { transform: scale(1); }
      .ripple { position:absolute; border-radius:50%; pointer-events:none; transform:scale(0); opacity:.9; }
      #confetti-canvas { position: fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:9999; mix-blend-mode: normal; }
      #motivPopup { transition: transform .36s cubic-bezier(.2,.9,.3,1), opacity .36s; }
      .particle { position: absolute; pointer-events:none; will-change: transform, opacity; }
    `;
    document.head.appendChild(s);
  })();

  /* ========== UTILS: merge server + optimistic ======== */
  function mergeServerAndOptimistic(server, optimistic){
    const merged = {...server};
    for(const date in optimistic){
      merged[date] = {...(merged[date]||{}), ...(optimistic[date]||{})};
    }
    return merged;
  }

  /* ========== UI: Week bar & Today ======== */
  function renderTodayDate(){
    const opts={day:'numeric',month:'long',year:'numeric'};
    todayEl.textContent = today.toLocaleDateString('pl-PL',opts);
  }
  function weekStartFromOffset(){
    const base = new Date(currentDate);
    const day = base.getDay();
    const monday = new Date(base);
    monday.setDate(base.getDate() - ((day+6)%7) + weekOffset*7);
    monday.setHours(0,0,0,0);
    return monday;
  }
  function renderWeekBar(){
    weekBar.innerHTML='';
    const start = weekStartFromOffset();
    for(let i=0;i<7;i++){
      const d=new Date(start); d.setDate(start.getDate()+i);
      const col = document.createElement('div'); col.className='week-col';
      col.innerHTML = `<small>${DAY_NAMES[i]}</small><span class='num'>${d.getDate()}</span>`;
      if(iso(d) === iso(currentDate)) col.classList.add('active');
      col.onclick = ()=>{ currentDate = new Date(d); renderAll(); };
      weekBar.appendChild(col);
    }
  }
  document.getElementById('prevWeek').onclick = ()=>{ weekOffset--; renderAll(); };
  document.getElementById('nextWeek').onclick = ()=>{ weekOffset++; renderAll(); };

  /* ========== PICKERS INIT ========== */
  function initPickers(){
    iconGrid.innerHTML=''; colorGrid.innerHTML='';
    ICONS.forEach((ic,idx)=>{
      const el = document.createElement('div'); el.className='icon-choice'; el.textContent=ic;
      el.onclick = ()=>{ selectedIcon=ic; [...iconGrid.children].forEach(x=>x.classList.remove('active')); el.classList.add('active'); };
      iconGrid.appendChild(el); if(idx===0) el.classList.add('active');
    });
    COLORS.forEach((c,idx)=>{
      const el = document.createElement('div'); el.className='color-choice'; el.style.background=c;
      el.onclick = ()=>{ selectedColor=c; [...colorGrid.children].forEach(x=>x.classList.remove('active')); el.classList.add('active'); };
      colorGrid.appendChild(el); if(idx===0) el.classList.add('active');
    });
    weekSelect.innerHTML=''; DAY_NAMES.forEach((d,i)=>{
      const b=document.createElement('div'); b.className='icon-choice'; b.style.width='44px'; b.style.height='44px'; b.textContent=d;
      b.onclick = ()=>{ if(selectedDays.includes(i)) selectedDays = selectedDays.filter(x=>x!==i); else selectedDays.push(i); b.classList.toggle('active'); };
      weekSelect.appendChild(b);
    });
  }
  initPickers();
  recurrence.onchange = (e)=> {
    weekSelect.style.display = e.target.value === 'repeat' ? 'flex' : 'none';
    if(e.target.value === 'daily'){ selectedDays = [0,1,2,3,4,5,6]; [...weekSelect.children].forEach(n=>n.classList.add('active')); }
    if(e.target.value !== 'repeat'){ selectedDays = []; [...weekSelect.children].forEach(n=>n.classList.remove('active')); }
  };

  /* ========== AUTH UI & flows ========== */
  function renderAuthUI(){
    authRow.innerHTML = '';
    const current = auth.currentUser;
    if(current){
      const span = document.createElement('div'); span.className='user-bubble'; span.textContent = current.email || current.displayName || 'User';
      const btn = document.createElement('button'); btn.className='sign-btn'; btn.textContent='Wyloguj';
      btn.onclick = async ()=> {
        try{
          await signOut(auth);
        }catch(e){
          console.error('signOut err', e);
        }
      };
      authRow.append(span, btn);
    } else {
      const btn = document.createElement('button'); btn.id='btnSignInLocal'; btn.className='sign-btn'; btn.textContent='Zaloguj';
      btn.onclick = ()=> authBackdrop.style.display='flex';
      authRow.append(btn);
    }
  }
  btnSignIn.onclick = ()=> authBackdrop.style.display='flex';
  authClose.onclick = ()=> authBackdrop.style.display='none';
  showEmail.onclick = ()=> { emailForm.style.display = 'flex'; };

  googleSign.onclick = async ()=>{
    try{
      await signInWithPopup(auth, provider);
      authBackdrop.style.display='none';
    } catch(e){
      console.error('Google sign-in error:', e);
      alert('Google sign-in error: '+(e.message||e));
    }
  };
  emailSignUp.onclick = async ()=>{ 
    const email = emailInput.value.trim(); const pass = passInput.value;
    if(!email||!pass) return alert('Wpisz email i hasÅ‚o');
    try{
      await createUserWithEmailAndPassword(auth,email,pass);
      authBackdrop.style.display='none';
    } catch(e){ console.error('register err', e); alert('BÅ‚Ä…d rejestracji: '+(e.message||e)); }
  };
  emailSignIn.onclick = async ()=>{ 
    const email = emailInput.value.trim(); const pass = passInput.value;
    if(!email||!pass) return alert('Wpisz email i hasÅ‚o');
    try{
      await signInWithEmailAndPassword(auth,email,pass);
      authBackdrop.style.display='none';
    } catch(e){ console.error('signin err', e); alert('BÅ‚Ä…d logowania: '+(e.message||e)); }
  };

  /* ========== FIRESTORE REALTIME SYNC ========== */
  let unsubHab = null, unsubComp = null;

  function startRealtimeSync(uid){
    console.log('Starting realtime sync for uid=', uid);
    if(unsubHab) try{ unsubHab(); }catch(e){}
    if(unsubComp) try{ unsubComp(); }catch(e){}

    // habits
    const colRef = collection(db, `users/${uid}/habits`);
    const q = query(colRef);
    unsubHab = onSnapshot(q, snapshot=>{
      const newCache = [];
      snapshot.forEach(ds=>{
        const data = ds.data();
        data._docId = ds.id;
        newCache.push(data);
      });
      habitsCache = newCache;
      renderDay();
    }, err=>{ console.error('habits onSnapshot err', err); });

    // completions (documents keyed by date)
    const compRef = collection(db, `users/${uid}/completions`);
    const q2 = query(compRef);
    unsubComp = onSnapshot(q2, snapshot=>{
      const comps = {};
      snapshot.forEach(ds=>{
        const d = ds.data();
        if(d && d.date && d.map) comps[d.date] = d.map;
      });
      serverCompletions = comps;
      completionsCache = mergeServerAndOptimistic(serverCompletions, optimisticCompletions);
      renderDay();
    }, err=>{ console.error('comps onSnapshot err', err); });
  }

  /* ========== HELPERS: CRUD & completions (ONLINE ONLY) ========== */
  function requireUserOrThrow(){
    const u = auth.currentUser;
    if(!u) throw new Error('Musisz byÄ‡ zalogowany, aby wykonaÄ‡ tÄ™ operacjÄ™.');
    return u;
  }

  async function addHabitToServer(h){
    const u = requireUserOrThrow();
    const payload = {...h};
    delete payload._tempId;
    try{
      const ref = await addDoc(collection(db, `users/${u.uid}/habits`), {...payload, createdAt: serverTimestamp()});
      console.log('habit added, id=', ref.id);
    }catch(e){
      console.error('addHabitToServer err', e);
      throw e;
    }
  }

  async function deleteHabitOnServer(docId){
    const u = requireUserOrThrow();
    try{
      await deleteDoc(doc(db, `users/${u.uid}/habits`, docId));
      console.log('deleted habit', docId);
    }catch(e){
      console.error('deleteHabitOnServer err', e);
      throw e;
    }
  }

  async function addExclusionOnServer(docId, dateIso){
    const u = requireUserOrThrow();
    try{
      const docRef = doc(db, `users/${u.uid}/habits`, docId);
      const hLocal = habitsCache.find(x=>x._docId===docId);
      const exclusions = (hLocal?.exclusions || []);
      if(!exclusions.includes(dateIso)) exclusions.push(dateIso);
      await updateDoc(docRef, { exclusions });
      console.log('added exclusion', dateIso, 'to', docId);
    }catch(e){
      console.error('addExclusionOnServer err', e);
      throw e;
    }
  }

  async function toggleCompletionServer(habitDocId, dateIso){
    const u = requireUserOrThrow();
    try{
      const docRef = doc(db, `users/${u.uid}/completions`, dateIso);
      const existing = serverCompletions[dateIso] ? {...serverCompletions[dateIso]} : {};
      existing[habitDocId] = !existing[habitDocId];
      await setDoc(docRef, { userId: u.uid, date: dateIso, map: existing }, { merge: true });
      console.log('toggled completion (server)', habitDocId, dateIso, existing[habitDocId]);
    }catch(e){
      console.error('toggleCompletionServer err', e);
      throw e;
    }
  }

  /* ========== RENDER DAY ======== */
  function matches(h,d){
    if(!h) return false;
    if(h.recurrence === 'once') return h.date === iso(d);
    if(h.recurrence === 'daily') return !(Array.isArray(h.exclusions) && h.exclusions.includes(iso(d)));
    if(h.recurrence === 'repeat'){
      const idx = dayIdxFromDate(d);
      const inDays = Array.isArray(h.days) && h.days.includes(idx);
      const excluded = Array.isArray(h.exclusions) && h.exclusions.includes(iso(d));
      return inDays && !excluded;
    }
    return false;
  }

  function renderDay(){
    const list = habitsList; list.innerHTML='';
    completionsCache = mergeServerAndOptimistic(serverCompletions, optimisticCompletions);
    const items = (habitsCache||[]).filter(h=>matches(h,currentDate)).sort((a,b)=> (a.start||'').localeCompare(b.start||'') || (a.name||'').localeCompare(b.name||''));
    emptyState.style.display = items.length ? 'none' : 'block';
    let idx = 0;
    items.forEach(h=>{
      const card = document.createElement('div'); card.className='habit-card';
      try{ card.animate([{opacity:0, transform:'translateY(6px)'},{opacity:1, transform:'translateY(0)'}], {duration:320, easing:'cubic-bezier(.2,.9,.3,1)', delay: idx*36}); }catch(e){}
      idx++;

      const docId = h._docId || h.id || '';
      if(completionsCache[iso(currentDate)]?.[docId]) card.classList.add('done');
      const row = document.createElement('div'); row.className='habit-row';

      const check = document.createElement('div'); check.className='check'; check.style.color = h.color || selectedColor;
      check.style.borderRadius = '8px'; check.style.width = '36px'; check.style.height = '36px';
      check.style.display = 'flex'; check.style.alignItems='center'; check.style.justifyContent='center';
      check.style.fontSize = '18px';
      if(completionsCache[iso(currentDate)]?.[docId]) check.classList.add('filled');

      // single toggle handler (debounced short)
      let lastToggle = 0;
      const TOGGLE_DEBOUNCE_MS = 300;
      const doToggle = (e)=>{
        if(e && e.stopPropagation) e.stopPropagation();
        const now = Date.now();
        if(now - lastToggle < TOGGLE_DEBOUNCE_MS) return;
        lastToggle = now;
        toggleDone(docId);
        animateDoneVisual(card,check,docId,h);
      };
      check.addEventListener('click', doToggle, {passive:true});

      // enable swipe on the row â€” action uses same single function
      enableSwipe(row, ()=>{ doToggle(); });

      const icon = document.createElement('div'); icon.className='icon'; icon.textContent = h.icon || 'ğŸƒ'; icon.style.background = (h.color||selectedColor)+'22';
      icon.style.display='flex'; icon.style.alignItems='center'; icon.style.justifyContent='center'; icon.style.width='44px'; icon.style.height='44px';
      icon.style.borderRadius='10px'; icon.style.fontSize='20px';

      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<div class='title'>${escapeHtml(h.name)}</div><div class='time'>${h.start? h.start : ''}${h.end? ' â€” '+h.end : ''}</div>`;
      if(completionsCache[iso(currentDate)]?.[docId]) meta.classList.add('done');

      const del = document.createElement('button'); del.className='btn-del'; del.textContent='UsuÅ„';
      del.onclick = (e)=>{ e.stopPropagation(); showDeleteModal(h, card); };

      row.append(check, icon, meta, del);
      card.appendChild(row);
      if(h.desc){ const ex = document.createElement('div'); ex.className='habit-extra'; ex.textContent = h.desc; card.appendChild(ex); }
      card.addEventListener('click', (e)=>{ const t=e.target; if(t===check||t===del) return; card.classList.toggle('expanded'); });

      list.appendChild(card);
    });
  }

  /* ========== ANIMATIONS, MOTIVATION & UI FEEDBACK (IMPROVED) ======== */
  const SHOW_MOTIVATION = true; // set to false to hide messages
  const MOTIVATION_MSGS = [
    "Great job!",
    "Keep it up!",
    "Nice progress!",
    "One step closer!",
    "You're doing awesome!"
  ];

  // create confetti canvas
  const confettiCanvas = document.createElement('canvas');
  confettiCanvas.id = 'confetti-canvas';
  confettiCanvas.width = innerWidth;
  confettiCanvas.height = innerHeight;
  document.body.appendChild(confettiCanvas);
  let confettiCtx = confettiCanvas.getContext('2d');
  let confettiParticles = [];
  let confettiRunning = false;
  window.addEventListener('resize', ()=>{ confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; confettiCtx = confettiCanvas.getContext('2d'); });

  function spawnConfettiBurst(xPct=50, yPct=80, count=26, baseColor){
    // xPct, yPct relative percentages of viewport (0-100)
    const startX = confettiCanvas.width * (xPct/100);
    const startY = confettiCanvas.height * (yPct/100);
    const colors = baseColor ? [baseColor, '#f59e0b','#10b981','#ef4444','#3b82f6'] : ['#f59e0b','#10b981','#ef4444','#3b82f6','#a855f7','#06b6d4'];
    for(let i=0;i<count;i++){
      const angle = (Math.PI * (Math.random()*1.2 - 0.6)); // spread
      const speed = 2 + Math.random()*6;
      confettiParticles.push({
        x: startX,
        y: startY,
        vx: Math.cos(angle)*speed*(0.6 + Math.random()),
        vy: Math.sin(angle)*speed*(0.6 + Math.random()) - 2,
        rot: Math.random()*360,
        vr: (Math.random()-0.5)*18,
        size: 6 + Math.random()*10,
        color: colors[Math.floor(Math.random()*colors.length)],
        life: 60 + Math.random()*40
      });
    }
    if(!confettiRunning) runConfetti();
  }

  function runConfetti(){
    confettiRunning = true;
    const loop = ()=>{
      confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
      for(let i = confettiParticles.length - 1; i >= 0; i--){
        const p = confettiParticles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.12; // gravity
        p.vx *= 0.995;
        p.rot += p.vr;
        p.life--;
        confettiCtx.save();
        confettiCtx.translate(p.x, p.y);
        confettiCtx.rotate(p.rot * Math.PI/180);
        confettiCtx.fillStyle = p.color;
        confettiCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
        confettiCtx.restore();
        if(p.y > confettiCanvas.height + 80 || p.life <= 0){
          confettiParticles.splice(i,1);
        }
      }
      if(confettiParticles.length > 0){
        requestAnimationFrame(loop);
      } else {
        confettiRunning = false;
        confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
      }
    };
    requestAnimationFrame(loop);
  }

  function showMotivationOneShot(){
    if(!SHOW_MOTIVATION) return;
    const msg = MOTIVATION_MSGS[Math.floor(Math.random()*MOTIVATION_MSGS.length)];
    if(!motivPopup) return;
    motivPopup.textContent = msg;
    motivPopup.style.opacity = '0';
    motivPopup.style.transform = 'translateY(10px) scale(.96)';
    motivPopup.classList.add('show');
    requestAnimationFrame(()=>{
      motivPopup.style.transition = 'transform .42s cubic-bezier(.2,.9,.3,1), opacity .42s';
      motivPopup.style.opacity = '1';
      motivPopup.style.transform = 'translateY(0px) scale(1)';
    });
    setTimeout(()=>{ motivPopup.style.opacity='0'; motivPopup.style.transform='translateY(10px) scale(.96)'; setTimeout(()=>motivPopup.classList.remove('show'),420); }, 1200);
  }

  function animateDoneVisual(card, check, id, habit){
    const dateIso = iso(currentDate);
    const filled = !!(completionsCache[dateIso]?.[id]);
    // ripple behind the check
    const rect = card.getBoundingClientRect();
    const ripple = document.createElement('div');
    ripple.className = 'ripple';
    ripple.style.width = '20px';
    ripple.style.height = '20px';
    ripple.style.left = (rect.left + rect.width/2 - 10) + 'px';
    ripple.style.top = (rect.top + rect.height/2 - 10) + 'px';
    ripple.style.background = (habit?.color || selectedColor) + '55';
    ripple.style.position = 'fixed';
    ripple.style.zIndex = 9998;
    ripple.style.transform = 'scale(0)';
    ripple.style.opacity = '0.9';
    ripple.style.borderRadius = '50%';
    document.body.appendChild(ripple);
    ripple.animate([
      { transform: 'scale(0)', opacity: 0.9 },
      { transform: 'scale(6)', opacity: 0.14 }
    ], { duration: 520, easing: 'cubic-bezier(.2,.9,.3,1)' });
    setTimeout(()=>{ try{ ripple.remove(); }catch(e){} }, 560);

    // check mark/fling animation
    try{
      if(filled){
        check.animate([{ transform: 'scale(.92)' }, { transform: 'scale(1.28)' }, { transform: 'scale(1)' }], { duration: 420, easing: 'cubic-bezier(.2,.9,.3,1)' });
        card.animate([{ transform: 'translateY(0)' }, { transform: 'translateY(-8px)' }, { transform: 'translateY(0)' }], { duration: 520, easing: 'cubic-bezier(.2,.9,.3,1)' });
        card.classList.add('flash-done');
        setTimeout(()=>card.classList.remove('flash-done'),900);
        // confetti burst near the card: compute center pct
        const centerX = (rect.left + rect.width/2) / window.innerWidth * 100;
        const centerY = (rect.top + rect.height/2) / window.innerHeight * 100;
        spawnConfettiBurst(centerX, centerY, 26, habit?.color);
        showMotivationOneShot();
      } else {
        // unfill animation
        check.animate([{ transform: 'scale(1.08)' }, { transform: 'scale(.96)' }, { transform: 'scale(1)' }], { duration: 320, easing: 'cubic-bezier(.2,.9,.3,1)' });
      }
    }catch(e){
      console.warn('animateDoneVisual err', e);
    }
  }

  /* ========== SWIPE SUPPORT (IMPROVED & LIGHTWEIGHT) ======== */
  function enableSwipe(el, action){
    let sx=0,cx=0,drag=false, isMouse=false, lastTime=0;
    const THRESHOLD = 90;
    const onTouchStart = (e)=>{ drag=true; isMouse=false; sx = e.touches[0].clientX; el.style.transition='none'; lastTime = Date.now(); };
    const onTouchMove = (e)=>{ if(!drag) return; cx = e.touches[0].clientX - sx; if(cx<0) cx=0; el.style.transform = `translateX(${cx}px)`; };
    const onTouchEnd = ()=>{ el.style.transition='transform 320ms cubic-bezier(.2,.9,.3,1)'; el.style.transform='translateX(0)'; if(cx>THRESHOLD) action(); drag=false; cx=0; };

    const onMouseDown = (e)=>{ drag=true; isMouse=true; sx=e.clientX; el.style.transition='none'; lastTime = Date.now(); };
    const onMouseMove = (e)=>{ if(!drag || !isMouse) return; cx = e.clientX - sx; if(cx<0) cx=0; el.style.transform = `translateX(${cx}px)`; };
    const onMouseUp = ()=>{ if(!drag) return; drag=false; isMouse=false; el.style.transition='transform 320ms cubic-bezier(.2,.9,.3,1)'; el.style.transform='translateX(0)'; if(cx>THRESHOLD) action(); cx=0; };

    el.addEventListener('touchstart', onTouchStart, {passive:true});
    el.addEventListener('touchmove', onTouchMove, {passive:true});
    el.addEventListener('touchend', onTouchEnd, {passive:true});

    el.addEventListener('mousedown', onMouseDown);
    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);
  }

  /* ========== ADD HABIT UI ======== */
  openAddBtn.onclick = ()=>{ modalBackdrop.style.display='flex'; habitNameInput.value=''; habitDescInput.value=''; document.getElementById('recurrence').value='once'; weekSelect.style.display='none'; selectedDays=[]; [...weekSelect.children].forEach(n=>n.classList.remove('active')); };
  cancelAdd.onclick = ()=> modalBackdrop.style.display='none';

  saveAdd.onclick = async ()=>{
    try{
      const u = auth.currentUser;
      if(!u) return alert('Please sign in to add habits.');

      const name = habitNameInput.value.trim() || 'Habit';
      const desc = habitDescInput.value.trim() || '';
      const start = startTimeInput.value || '';
      const end = endTimeInput.value || '';
      const rec = recurrence.value || 'once';
      const base = { name, desc, icon: selectedIcon, color: selectedColor, start, end, recurrence: rec, exclusions: [] };
      if(rec==='once') base.date = iso(currentDate);
      if(rec==='repeat') base.days = [...selectedDays];
      if(rec==='daily') base.days=[0,1,2,3,4,5,6];

      await addHabitToServer(base);
      modalBackdrop.style.display='none';
    }catch(e){
      console.error('saveAdd err', e);
      alert('Save error: ' + (e.message||e));
    }
  };

  /* ========== COMPLETION TOGGLE (optimistic) ======== */
  function toggleDone(habitDocId){
    try{
      const u = auth.currentUser;
      if(!u){ return alert('Please sign in to mark completions.'); }
      const dateIso = iso(currentDate);

      completionsCache[dateIso] = completionsCache[dateIso] || {};
      optimisticCompletions[dateIso] = optimisticCompletions[dateIso] || {};

      const newVal = !completionsCache[dateIso][habitDocId];
      completionsCache[dateIso][habitDocId] = newVal;
      optimisticCompletions[dateIso][habitDocId] = newVal;

      renderDay();

      toggleCompletionServer(habitDocId, dateIso).catch(err=>{
        console.error('toggle comp error', err);
        optimisticCompletions[dateIso][habitDocId] = serverCompletions[dateIso]?.[habitDocId] ?? undefined;
        completionsCache = mergeServerAndOptimistic(serverCompletions, optimisticCompletions);
        renderDay();
        alert('Error saving completion.');
      });
    }catch(e){ console.error(e); }
  }

  /* ========== DELETE CONFIRM MODAL ======== */
  let deleteContext = null;
  function showDeleteModal(h, element){
    deleteContext = { h, element };
    confirmTitle.textContent = `Delete "${h.name}"?`;
    confirmText.textContent = h.recurrence === 'once' ? 'Remove this habit?' : 'Remove only today (add exclusion) or permanently?';
    confirmBtns.innerHTML = '';
    const btnCancel = document.createElement('button'); btnCancel.className='cbtn cbtn-cancel'; btnCancel.innerHTML='<span class="small-ico">âœ–</span>Cancel';
    btnCancel.onclick = ()=>{ confirmBackdrop.style.display='none'; deleteContext=null; };
    confirmBtns.appendChild(btnCancel);

    if(h.recurrence === 'once'){
      const btnDelete = document.createElement('button'); btnDelete.className='cbtn cbtn-all'; btnDelete.innerHTML='<span class="small-ico">ğŸ—‘ï¸</span>Delete';
      btnDelete.onclick = async ()=>{
        confirmBackdrop.style.display='none';
        try{
          if(!h._docId) throw new Error('Missing id');
          await deleteHabitOnServer(h._docId);
        }catch(e){ console.error(e); alert('Deletion error'); }
        deleteContext=null;
      };
      confirmBtns.appendChild(btnDelete);
    } else {
      const btnOnly = document.createElement('button'); btnOnly.className='cbtn cbtn-only'; btnOnly.innerHTML='<span class="small-ico">ğŸ—“ï¸</span>Only today';
      btnOnly.onclick = async ()=>{
        confirmBackdrop.style.display='none';
        const dayIso = iso(currentDate);
        try{
          if(!h._docId) throw new Error('Missing id');
          await addExclusionOnServer(h._docId, dayIso);
        }catch(e){ console.error(e); alert('Error'); }
        deleteContext=null;
      };
      const btnAll = document.createElement('button'); btnAll.className='cbtn cbtn-all'; btnAll.innerHTML='<span class="small-ico">ğŸ—‘ï¸</span>Delete permanently';
      btnAll.onclick = async ()=>{
        confirmBackdrop.style.display='none';
        try{
          if(!h._docId) throw new Error('Missing id');
          await deleteHabitOnServer(h._docId);
        }catch(e){ console.error(e); alert('Error'); }
        deleteContext=null;
      };
      confirmBtns.appendChild(btnOnly); confirmBtns.appendChild(btnAll);
    }
    confirmBackdrop.style.display='flex';
  }

  /* ========== AUTH LISTENER & START SYNC ======== */
  onAuthStateChanged(auth, async (u)=>{
    console.log('onAuthStateChanged:', u ? u.uid : null);
    renderAuthUI();
    if(u){
      startRealtimeSync(u.uid);
    } else {
      if(typeof unsubHab === 'function') try{ unsubHab(); }catch(e){}
      if(typeof unsubComp === 'function') try{ unsubComp(); }catch(e){}
      habitsCache = [];
      serverCompletions = {};
      optimisticCompletions = {};
      completionsCache = {};
      renderAll();
    }
  });

  /* ========== NAV BAR (bottom) ======== */
  function setActiveNav(el){
    [navHome, navEvents, navSettings].forEach(n=>n.classList.remove('active'));
    if(el) el.classList.add('active');
  }
  navHome.onclick = ()=>{ setActiveNav(navHome); };
  navEvents.onclick = ()=>{ setActiveNav(navEvents); window.location.href = 'events.html'; };
  navSettings.onclick = ()=>{ setActiveNav(navSettings); window.location.href = 'settings.html'; };

  /* ========== RENDER ALL ======== */
  function renderAll(){ renderTodayDate(); renderWeekBar(); renderDay(); renderAuthUI(); }
  renderAll();

  /* ========== SERVICE WORKER (optional) ======== */
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').then(()=>console.log('sw registered')).catch(()=>{});
  }

  /* ========== SMALL HELPERS ========== */
  function escapeHtml(s){
    if(!s) return '';
    return s.replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

</script>
